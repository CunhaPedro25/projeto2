create table state
(
	id integer generated by default as identity
		constraint state_pk
			primary key,
	description text
);

create table construction_type
(
    id integer generated by default as identity
        constraint construction_type_pk
            primary key,
    type varchar
);

create table material
(
	id integer generated by default as identity
		constraint material_pk
			primary key,
	name varchar not null,
	value_unit decimal not null,
	quantity integer not null
);

create table user_type
(
	id integer generated by default as identity
		constraint client_type_pk
			primary key,
	type varchar not null
);

create table zipcode
(
	id varchar not null
		constraint zipcode_pk
			primary key,
	district varchar not null,
	city varchar not null,
	locale varchar not null
);

create table "user"
(
	id integer generated by default as identity
		constraint client_pk
			primary key,
	name varchar(70),
	email varchar(254) not null
		constraint email_uk
			unique,
	password varchar not null,
	phone varchar not null
		constraint phone_uk
			unique,
	address text,
	door integer,
	zipcode varchar
		constraint client_zipcode_zipcode_fk
			references zipcode,
	user_type integer not null
		constraint user_type_fk
			references user_type,
    team integer null,
	active boolean default true
);

create table team
(
	id integer generated by default as identity
		constraint team_pk
			primary key,
	busy boolean default false,
	leader integer null
		constraint leader_id_fk
			references "user",
    daily_value decimal not null
);

alter table "user"
	add constraint team_id_fk
		foreign key (team) references team;

create table project
(
    id integer generated by default as identity
        constraint projects_pk
            primary key,
    client integer not null
		constraint client_id_fk
			references "user",
	engineer integer not null
		constraint engineer_id_fk
			references "user",
    construction_type integer not null
        constraint construction_type_fk
            references construction_type,
    requirements_create_date date null,
    budget_create_date date null,
    requirements_document varchar null,
    budget_document varchar null,
    budget decimal null,
    requirements_state bool null,
    budget_state bool null
);

create table stage
(
    id integer generated by default as identity
		constraint stage_pk
			primary key,
    name varchar,
    percentage float,
    construction_type integer not null
		constraint construction_type_fk
			references construction_type
);

create table if not exists construction
(
    id integer generated by default as identity
		constraint construction_pk
			primary key,
    project integer not null
        constraint project_id_fk
			references project,
    team integer
        constraint team_id_fk
			references team,
    stage integer
        constraint stage_id_fk
			references stage,
    stage_budget decimal,
    total decimal,
    state integer
        constraint state_id_fk
			references state
);


create table construction_material
(
	construction integer not null
		constraint construction_id_fk
			references construction,
	material integer not null
		constraint material_id_fk
			references material,
	quantity integer not null,
	constraint construction_material_pk
		primary key (material, construction)
);

create table if not exists construction_team
(
    id integer generated by default as identity
		constraint construction_team_pk
			primary key,
    team integer
        constraint team_id_fk
			references team,
    construction integer
        constraint construction_id_fk
			references construction,
    start_date date,
    end_date date,
    days integer,
    daily_value decimal
);

create table complaint
(
	id integer generated by default as identity
		constraint complaint_pk
			primary key,
	client integer not null
		constraint client_id_fk
			references "user",
	construction integer not null
		constraint construction_id_fk
			references construction,
	description text not null
);

create table invoice
(
	id integer generated by default as identity
		constraint invoice_pk
			primary key,
	stage integer not null
		constraint invoice_stage_id_fk
			references stage,
	client integer not null
		constraint client_id_fk
			references "user",
	stage_total decimal,
    budget_total decimal,
    percentage float,
	issue_date date default CURRENT_DATE,
	paid boolean default false
);

